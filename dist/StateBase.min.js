/*! agt-dynamicRoutingShared - v0.0.1 - 2013-06-11
 * https://github.com/afterglowtech/agt-dynamicRoutingShared
 * Copyright (c) 2013 Stu Salsbury;
 *    Based on https://github.com/angular-ui/ui-router which is 
 *    Copyright (c) 2013, Karsten Sperling
 * Licensed MIT
 */
define(["common","UrlMatcher"],function(t,e){function i(){this.children={}}function r(t,e,i,r){if(r=r!==void 0?r:!1){var n=e;e=i,i=n}t[e]&&(t[i]=t[e],delete t[e])}var n="abstract";return Object.defineProperty(i.prototype,"self",{get:function(){return this}}),i.prototype.resetAll=function(){},i.prototype.initialize=function(t){if(this.needsInit||t){this.resetAll();for(var e in this.children)this.children[e].initialize(!0);this.needsInit=!1}},Object.defineProperty(i.prototype,"fullName",{get:function(){return this._fullName}}),Object.defineProperty(i.prototype,"name",{get:function(){return this._fullName}}),Object.defineProperty(i.prototype,"localName",{get:function(){return this._localName},set:function(t){this.validateName(t),this._localName=t,this.needsInit=!0}}),i.prototype.resetFullName=function(){this._fullName=this.parent.fullName?this.parent.fullName+"."+this.localName:this.localName},i.prototype.toString=function(){return this.fullName},i.prototype.validateName=function(e){if(!t.isString(e)||e.indexOf("@")>=0)throw Error("Invalid local state name ("+e+")")},Object.defineProperty(i.prototype,"root",{get:function(){return this.parent.root}}),Object.defineProperty(i.prototype,"children",{get:function(){return this._children},set:function(t){if(this._children=t,this._children)for(var e in this._children)this._children[e].parent=this}}),i.prototype.resetPath=function(){this.path=this.parent.path.concat(this)},Object.defineProperty(i.prototype,"url",{get:function(){return this._url},set:function(t){this._url=t,this.needsInit=!0}}),Object.defineProperty(i.prototype,"aliases",{get:function(){return this._aliases},set:function(t){this._aliases=t,this.needsInit=!0}}),i.prototype.resetUrls=function(){if(this.preparedUrl=null,t.isString(this.url))this.preparedUrl="^"===this.url.charAt(0)?new e(this.url.substring(1)):(this.parent.navigable||this.root).preparedUrl.concat(this.url);else if(t.isObject(this.url)&&t.isFunction(this.url.exec)&&t.isFunction(this.url.format)&&t.isFunction(this.url.concat))this.preparedUrl=this.url;else if(null!=this.url)throw Error("Invalid url "+this.url+" in state "+this);if(this.aliases){this.preparedAliases=[];for(var i in this.aliases)"^"===i.charAt(0)?this.preparedAliases.push(new e(i.substring(1))):this.preparedAliases.push((this.parent.navigable||this.root).preparedUrl.concat(i))}else this.preparedAliases=null},Object.defineProperty(i.prototype,"params",{get:function(){return this._params},set:function(t){this._params=t,this.needsInit=!0}}),i.prototype.resetParams=function(){},i.prototype.resetNavigable=function(){this.navigable=this.url?this:this.parent?this.parent.navigable:null},Object.defineProperty(i.prototype,n,{get:function(){return this._abstract},set:function(t){this._abstract=t,this.needsInit=!0}}),i.prototype.resetIncludes=function(){this.includes=this.parent?t.extend({},this.parent.includes):{},this.includes[this.name]=!0},Object.defineProperty(i.prototype,"views",{get:function(){return this._views},set:function(t){this._views=t,this.needsInit=!0}}),i.prototype.resetViews=function(){var e=this,i={},r=this.views;t.forEach(t.isDefined(r)?r:{"":e},function(t,r){0>r.indexOf("@")&&(r=r+"@"+e.parent.name),i[r]=t}),this.preparedViews=i},i.prototype.resetUrlHandlers=function(){},i.prototype.newInstance=function(){return new i},i.prototype.getChild=function(t){return this.children?this.children[t]:null},i.prototype.setChild=function(e,i){var r=this.newInstance();return t.extend(r,e),this.setChildState(r,i)},i.prototype.removeChild=function(t){return this.children[t]&&delete this.children[t],this},i.prototype.setChildState=function(t,e){if(!e){var i=this.getChild(t.localName),r=i?i.children:null;r&&(t._children=r)}return this.children[t.localName]=t,t.parent=this,this.needsInit=!0,t},i.prototype.updateChild=function(e){var i=this.getChild(e.localName);return i?(t.extend(i,e),this.setChildState(i,!1)):this.setChild(e,!0)},i.prototype.prepFlatGetParent=function(t){var e,i;if(t.parent)e=this.getState(t.parent),i=t.fullName;else{var r=t.fullName?t.fullName:t.name,n=/^(.*?)\.?([^\.]*)$/.exec(r),s=n[1];i=n[2],e=s?this.getState(s):this.root}return t.localName=i,delete t.name,delete t.fullName,delete t.parent,e},i.prototype.setState=function(t,e){var i=this.prepFlatGetParent(t);return i.setChild(t,e)},i.prototype.updateState=function(t){var e=this.prepFlatGetParent(t);return e.updateChild(t)},i.prototype.findState=function(t){var e=/^([^\.]+)(\.(.*))?$/.exec(t),i=e[1];if(this.localName===i){var r=e[3];return r?this.findStateChildren(r):this}return null},i.prototype.findStateChildren=function(t){if(this.children)for(var e in this.children){var i=this.children[e].findState(t);if(i)return i}return null},i.prototype.getState=function(e){return t.isString(e)?this.root.findStateChildren(e):this.root.findStateChildren(e.fullName)},i.prototype.getIntJson=function(t,e,i){return t[i]?parseInt(t[i],10):t[e]?parseInt(t[e],10):null},i.prototype.getObjJson=function(t,e,i){return t[i]?t[i]:t[e]?t[e]:null},i.prototype.jsonConvert=function(t,e){r(t,"lazy","z",e),r(t,"delete","x",e),r(t,"definition","d",e);var i=t.definition||t.d;if(i){r(i,"url","u",e),r(i,"dependencies","d",e),r(i,"resolveByService","r",e),r(i,"templateService","i",e),r(i,"aliases","s",e),r(i,"controller","c",e),r(i,"templateUrl","t",e),r(i,"template","l",e),r(i,"data","a",e),r(i,"abstract, ","b",e),r(i,"views","v",e);var n=i.views||i.v;if(n)for(var s in n){var o=n[s];r(o,"url","u",e),r(o,"resolveByService","r",e),r(o,"templateService","i",e),r(o,"controller","c",e),r(o,"templateUrl","t",e),r(o,"template","l",e),r(o,"data","a",e)}}r(t,"children","c",e);var a=t.children||t.c;if(a)for(var l in a){var h=a[l];this.jsonConvert(h,e)}},i.prototype.mergeChild=function(t,e){if(e["delete"])this.removeChild(t);else{var i=e.definition;i&&(i.localName=t,this.updateChild(i));var r=e.children;if(r){var n=this.getChild(t);for(var s in r){var o=r[s];n.mergeChild(s,o)}}}return!0},Object.defineProperty(i.prototype,"knownStates",{get:function(){var t={};if(Object.keys(this.children).length>0){var e={};for(var i in this.children){var r=this.children[i];e[r.localName]=r.knownStates}t=e}return t}}),i});